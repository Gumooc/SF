<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<title></title>
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<link href="css/mui.min.css" rel="stylesheet" />
	<link href="css/bar.css" rel="stylesheet" />
	<link href="css/section.css" rel="stylesheet" />
	<script src='js/ajax.js'></script>
	<script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
	<style>
		body{
			padding: 0px;
			margin: 0px ;
			
		}
		.bm-edit-div-2{
			padding:5px;
			height: 50px;
			border-radius:10px;
		}
		.bm-edit-input-2{
			width: 100%;
			height: 90px;
			margin: 0px;
			border-radius: 10px;
		}
		.bm-edit-btn-5{
			font-size: 20px;
			padding: 5px 10px;
			float: right;
		}
		.bm-edit-div-3{
			border-radius: 10px;
			height: 210px;
			background: white;
		}
		.bm-edit-div-4{
			background: white;
			padding-bottom: 5px;
			width: 100%;
		}
		.bm-edit-div-5{
			height: 150px;
		}
		.bm-edit-radio-1{
			float: left;
			width: 29%;
			margin: 6px;
			padding: 0px;
			height: 40px;
			border: 1px solid #007AFF;
			border-radius: 10px;

		}
		.bm-edit-radio-2{
			background: yellowgreen;
		}
		.bm-new-radio-1{
			float: left;
			width: 29%;
			margin: 6px;
			padding: 0px;
			height: 40px;
			border-radius: 10px;
		}
		.mui-title{
			color: #007AFF;
		}
		#show{
			width: 150px;
			height: 150px;
			//background: indianred;
			margin: 10px auto;
			
		}
		#img{
			width: 200px;
			margin:0 auto;
		}
		.bm-new-div-5{
			background: white;
			height: 220px;
			text-align: center;
		}
		.mui-btn-block{height:40px;padding: 0px;}
		.chpt-pro{
			margin-left: 30px;
			font-size: 14px;
			color: #007AFF;
		}
	</style>
</head>

<body>
	<header class="mui-bar mui-bar-nav">
		<div class='mui-title'>编辑我的有声书</div>
		<a class="mui-icon mui-icon-left-nav mui-pull-left mui-action-back"></a>
	</header>
	
	<div class="mui-content">
		
			<div class="bar-new-div-1">修改标题</div>
			<input style="width:100%;border-radius:0px;margin: 0px;" id='name' placeholder="标题" type="text"/>
			<div class="bar-new-div-1">修改简介</div> 
			<textarea style="border-radius:0px;margin:0px" class="bm-new-input-2" placeholder="描述" id="des"></textarea>
			<div class="bar-new-div-1">更换封面</div>
			<div class="bm-new-div-5">
				<img id="show" class="headimg" src=''/>
				<div></div>
				<input type="file" id='img' onchange="hello()"/>
			</div>
			<div class="bar-new-div-1">修改分类</div>
			<div class="bm-edit-div-3">
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>其他</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>悬疑</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>生活</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>经典</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>武侠</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>教育</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>社科</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>经管</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>历史</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
				<div class='mui-card bm-new-radio-1'>
					<div class="mui-input-row mui-checkbox" >
					  <label>小说</label>
					  <input name="checkbox1" type="checkbox" >
					</div>
				</div>
			</div>
			
			<div class="bar-new-div-1">编辑章节</div>
			<div class='bm-edit-div-4'> 
				<!--<div class='mui-card section-div-1 bm-edit-btn-6'>
					<div class='section-info-1'>1</div>
					<div class='section-info-2'>前世恩怨</div>
					<button class='mui-btn mui-btn-primary section-btn-1'><icon class="mui-icon mui-icon-trash"></icon></button>
					<div class="pro-tip">hello</div>
				</div>
				<div class='mui-card section-div-1 bm-edit-btn-7'>
					<div class='section-info-1'>2</div>
					<div class='section-info-2'>添加章节</div>
					<button class='mui-btn mui-btn-primary section-btn-1'><icon class="mui-icon mui-icon-plus"></icon></button>
				</div>-->
			</div>
			
			<div class="mui-content-padded" >
				<button  class="mui-btn mui-btn-block mui-btn-primary" id='preview' >预览作品</button>
				<button  class="mui-btn mui-btn-block mui-btn-primary bm-edit-btn-2">保存修改</button>
				<button  class="mui-btn mui-btn-block mui-btn-primary " id='pub'>发布作品</button>

				<button  class="mui-btn mui-btn-block mui-btn-primary bm-edit-btn-5">删除作品</button>
			</div>
	</div>
	
	<script src="js/mui.min.js"></script>
	<script type="text/javascript">
		var self;
		var opener;
		var item={};
		var jarray;
		var bid;
		var bm_main;
		var uid;
		
		setInterval(clock,1000);
		function clock(){
			var chpt_ele=document.getElementsByClassName('chpt-pro');
			for(var i=0;i<chpt_ele.length;i++){
				chpt_ele[i].innerHTML='';
			}
			
			//console.log('hello');
		
			mui.ajax('http://49.234.77.32:8080/sfbook/createbook/making',{
				data:{},
				dataType:'json',
				type:'post',
				async:false,
				timeout:10000,
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					if(data.body!=null){
						var p=data.body;
						for(var i=0;i<p.length;i++){
							if(p[i].status=='制作完成')continue;
							if(p[i].bid!=bid)continue;
							var str=p[i].status+p[i].start+'/'+p[i].end+'..';
							var chpt_ele=document.getElementsByClassName('chpt-pro');
							chpt_ele[p[i].chapter-1].innerHTML=str;
							//console.log(p[i].chapter);
						}
					}
				},
				error:function(xhr,type,errorThrown){
					mui.toast('连接服务器出错',{ duration:'long', type:'div' });
					console.log(type);
				}
			});
		}

		mui.init();
		mui.plusReady(function(){
       		self=plus.webview.currentWebview();
       		opener=self.opener();
       		bm_main=plus.webview.getWebviewById('bm-main.html');
       		uid=plus.storage.getItem('uid');
       		mui.myAjax=myAjax;
   		});
   		//监听事件，预览
   		mui('body').on('tap','#preview',function(e){
   			mui.openWindow({
	    		url:'bi.html',
	    		id:'bi.html',
	    	});
	    	var bi=plus.webview.getWebviewById('bi.html');
	    	mui.fire(bi,'item',{bid:bid});
   		});
		//监听事件，删除有声书
   		mui('body').on('tap','.bm-edit-btn-5',function(e){
   			var bm_main=plus.webview.getWebviewById('bm-main.html');
   			plus.nativeUI.showWaiting();
   			mui.ajax('http://49.234.77.32:8080/sfbook/book/deletebook',{
				data:{bid:bid},
				dataType:'json',
				type:'post',
				async:false,
				timeout:10000,
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					if(data.resp=='s'){
						mui.fire(bm_main,'get',{});
						self.close();
						mui.fire(bm_main,'toast',{toast:'成功删除图书'});
					}
				},
				error:function(xhr,type,errorThrown){
					mui.toast('连接服务器出错',{ duration:'long', type:'div' });
					console.log(type);}
			});
			
			plus.nativeUI.closeWaiting();
   		});
   		//按钮事件，删除章节
   		mui('body').on('tap','.bm-edit-del-1',function(e){
   			var j=JSON.parse(item.chapter);
			jarray=j.body;
			var len=jarray.length;
			jarray.splice(len-1,1);
			j={body:jarray};
			var len2=jarray.length;
			
			//console.log(len+'？'+len2);
			
   			var chapter=JSON.stringify(j);
   			plus.nativeUI.showWaiting();
   			/*
   			mui.ajax('http://49.234.77.32:8080/sfbook/book/chapter',{
				data:{bid:bid,chapter:chapter},
				dataType:'json',
				type:'post',
				async:false,
				timeout:10000,
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					mui.toast('成功删除章节',{ duration:'long', type:'div' });
					mui.fire(self,'item',{bid:bid});
				},
				error:function(xhr,type,errorThrown){
					mui.toast('连接服务器出错',{ duration:'long', type:'div' });
					console.log('error');
				}
			});
			*/
			mui.myAjax('http://49.234.77.32:8080/sfbook/book/chapter',{
                        type:'post',
                        async:false,
                        timeout:5000,
                        headers:{'Content-Type':'application/json'},	
                        dataType:'json',
                        data:{bid:bid,chapter:chapter},
                    },
                function(data){
                	mui.toast('成功删除章节',{ duration:'long', type:'div' });
					mui.fire(self,'item',{bid:bid});
                },function(state,xhr){
                    console.log(state);
                    mui.toast('连接到服务器出错',{ duration:'long', type:'div' }) 
                }
            );
			plus.nativeUI.closeWaiting();
   		});
   		//按钮事件,添加章节
   		mui('body').on('tap','.bm-edit-btn-7',function(e){
   			mui.openWindow({
	    		url:'bm-serial.html',
	    		id:'bm-serial.html',
	    	});
	    	var bm_serial=plus.webview.getWebviewById('bm-serial.html');
   			mui.fire(bm_serial,'get',{bid:item.bid,sid:-1});
   		});
   		//按钮事件，提交修改
   		mui('body').on('tap','.bm-edit-btn-2',function(e){
   			var nitem={};
   			var des=document.getElementById('des').value;
			var img=document.getElementById('img').files[0];
   			var bm_main=plus.webview.getWebviewById('bm-main.html');
   			//可以修改的信息+图片+描述
   			nitem.bookname=document.getElementById('name').value;
   			
   			//不可修改的信息
   			nitem.shared=item.shared;
   			nitem.bid=item.bid;
   			nitem.playtime=item.playtime;
   			nitem.lst=getdt();
   			nitem.uid=parseInt(plus.storage.getItem('uid'));
   			nitem.kind=0;
   			var cb=document.getElementsByName('checkbox1');
   			for(var i=0;i<10;i++){
   				if(cb[i].checked){
   					var kid=(1<<i);
   					nitem.kind+=kid;
   				}
   			}
   			//未修改的信息
   			if(!nitem.bookname){nitem.bookname=item.bookname};
   			
   			mui.myAjax('http://49.234.77.32:8080/sfbook/book/updatebook',{
                        type:'post',
                        async:false,
                        timeout:5000,
                        headers:{'Content-Type':'application/json'},	
                        dataType:'json',
                        data:nitem
                    },
                function(data){
                },function(state,xhr){
                    console.log(state);
                    mui.toast('连接到服务器出错',{ duration:'long', type:'div' }) 
                }
            );
			
			//可能修改图片
			if(img){
				var formData=new FormData();
				formData.append('bid',item.bid);
	    		formData.append('file',img); 
				$.ajax({
			        url:'http://49.234.77.32:8080/sfbook/book/setImg',
			        type:'post',
			        dataType:'text',
			        cache: false,
			        processData: false,
			        contentType: false,
			        async:false,
			        data:formData,
			        success:function(list){  
			        },
			        error:function(){
			        	mui.toast('连接服务器出错',{ duration:'long', type:'div' });
			        	console.log("保存失败");}
			        
	    		});
			}
    		if(des){
    			mui.myAjax('http://49.234.77.32:8080/sfbook/book/insbookdes',{
	                        type:'post',
	                        async:false,
	                        timeout:5000,
	                        headers:{'Content-Type':'application/json'},	
	                        dataType:'json',
	                        data:{des:des,bid:item.bid}
	                    },
	                function(data){
	                    
	                },function(state,xhr){
	                    console.log(state);
	                    mui.toast('连接到服务器出错',{ duration:'long', type:'div' }) 
	                }
	            );
    		}
    		
			mui.fire(bm_main,'toast',{toast:'成功修改信息'});
			mui.fire(bm_main,'get',{});
			self.close();
			return;
   		})
		//按钮事件，发布作品或撤回发布
		mui('body').on('tap','#pub',function(e){
   			var bm_main=plus.webview.getWebviewById('bm-main.html');
   			var pub=document.getElementById('pub');
   			if(item.shared){
   				item.shared=false;
   				mui.myAjax('http://49.234.77.32:8080/sfbook/book/updatebook',{
	                        type:'post',
	                        async:false,
	                        timeout:5000,
	                        headers:{'Content-Type':'application/json'},	
	                        dataType:'json',
	                        data:item
	                    },
	                function(data){
	                	mui.fire(bm_main,'toast',{toast:'作品已经撤回'});
	                	mui.fire(bm_main,'get',{});
	                	self.close();
	                },function(state,xhr){
	                    console.log(state);
	                    mui.toast('连接到服务器出错',{ duration:'long', type:'div' }) 
	                }
	            );
   			}
   			else {
   				item.shared=true;
   				mui.myAjax('http://49.234.77.32:8080/sfbook/book/updatebook',{
	                        type:'post',
	                        async:false,
	                        timeout:5000,
	                        headers:{'Content-Type':'application/json'},	
	                        dataType:'json',
	                        data:item
	                    },
	                function(data){
	                	mui.fire(bm_main,'toast',{toast:'作品已经发布'});
	                	mui.fire(bm_main,'get',{});
	                	self.close();
	                },function(state,xhr){
	                    console.log(state);
	                    mui.toast('连接到服务器出错',{ duration:'long', type:'div' }) 
	                }
	            );
   			}
   			
		})
		
		//监听事件，加载图书信息
		window.addEventListener('item',function(event){
			bid=event.detail.bid;
			var ustr=plus.storage.getItem('uid');
			var uid=parseInt(ustr);
			
			mui.ajax('http://49.234.77.32:8080/sfbook/book/bookinfo',{
				data:{bid:event.detail.bid,uid:uid},
				dataType:'json',
				type:'post',
				async:false,
				timeout:10000,
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					item=data.body;
					//修改按钮
					var pub=document.getElementById('pub');
					if(item.shared)pub.innerHTML='撤回发布';
					else pub.innerHTML='发布作品';
					//添加分类
			
					var kind=document.getElementsByName('checkbox1');
					for(var i=0;i<10;i++){
						if(item.kind&(1<<i)){
							kind[i].checked=true;}
					}
					
					document.getElementById('name').placeholder=item.bookname;
					var html='';
					//添加章节
					var j=JSON.parse(item.chapter);
					jarray=j.body;
					var i;
					for(i=0;i<jarray.length;i++){
						html+="<div class='mui-card section-div-1 bm-edit-btn-6'>";
						html+="<div class='section-info-1'>"+(i+1)+"</div>";
						html+="<div class='section-info-2'>"+jarray[i].name+"<font class='chpt-pro'></font></div>";
						if(i==jarray.length-1){
							html+="<button class='mui-btn mui-btn-primary section-btn-1 bm-edit-del-1'><icon class='mui-icon mui-icon-trash'></icon></button>";
						}
						html+="</div>";
					}
					html+="<div class='mui-card section-div-1 bm-edit-btn-7'>";
					html+="<div class='section-info-1'>"+(i+1)+"</div>";
					html+="<div class='section-info-2'>"+'添加章节'+"</div>";
					html+="<button class='mui-btn mui-btn-primary section-btn-1'><icon class='mui-icon mui-icon-plus'></icon></button>";
					html+="</div>";
					document.getElementsByClassName('bm-edit-div-4')[0].innerHTML=html;
					var f= document.getElementById('show');
					f.src='data:image/jpg;base64,'+item.img;
				},
				error:function(xhr,type,errorThrown){
					mui.toast('连接服务器出错',{ duration:'long', type:'div' });
					console.log(type);
				}
			});
			mui.ajax('http://49.234.77.32:8080/sfbook/book/askbookdes',{
				data:{bid:event.detail.bid},
				dataType:'json',
				type:'post',
				async:false,
				timeout:10000,
				headers:{'Content-Type':'application/json'},	              
				success:function(data){
					document.getElementById('des').placeholder=data.body.des;			
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();
					mui.toast('连接服务器出错',{ duration:'long', type:'div' });
					console.log(type);}
			});
		});
		
		function hello(){
			var f= document.getElementById('img').files[0];
			if(window.FileReader) {
				var fr = new FileReader();
				
				var showimg = document.getElementById('show');
				fr.onloadend = function(e) {
					showimg.src = e.target.result;
				};
				fr.readAsDataURL(f);
				showimg.style.display = 'block';
			}
		}
   		//应用函数，获取时间
		function getdt(){
			var date=new Date(); 
			var year=date.getFullYear(); 
			var mon=date.getMonth()+1; 
		    var day=date.getDate();
		    var stamp=year+'-'+mon+'-'+day;
		    return stamp;
		}
		//监听事件，tosat
		window.addEventListener('toast',function(event){
			var toast=event.detail.toast;
			mui.toast(toast,{ duration:'long', type:'div' });
		});
	</script>
</body>

</html>